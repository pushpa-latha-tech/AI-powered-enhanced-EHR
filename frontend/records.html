<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Records - EHR GenAI</title>
    <meta name="description" content="View and search patient clinical records">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12" />
            <line x1="3" y1="6" x2="21" y2="6" />
            <line x1="3" y1="18" x2="21" y2="18" />
        </svg>
    </button>

    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                </svg>
                <div>
                    <h1>EHR GenAI</h1>
                    <span>Medical AI Platform</span>
                </div>
            </div>

            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="index.html" class="nav-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="9" />
                                <rect x="14" y="3" width="7" height="5" />
                                <rect x="14" y="12" width="7" height="9" />
                                <rect x="3" y="16" width="7" height="5" />
                            </svg>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="enhance.html" class="nav-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                <circle cx="8.5" cy="8.5" r="1.5" />
                                <polyline points="21 15 16 10 5 21" />
                            </svg>
                            Image Enhancement
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="generate.html" class="nav-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                <polyline points="14 2 14 8 20 8" />
                                <line x1="16" y1="13" x2="8" y2="13" />
                                <line x1="16" y1="17" x2="8" y2="17" />
                            </svg>
                            Clinical Notes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="records.html" class="nav-link active">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                <circle cx="9" cy="7" r="4" />
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                            </svg>
                            Patient Records
                        </a>
                    </li>
                </ul>
            </nav>

            <div style="margin-top: auto; padding-top: var(--space-lg); border-top: 1px solid var(--border-color);">
                <button class="nav-link theme-toggle-btn" onclick="EHRApp.toggleTheme()"
                    style="width: 100%; border: none; background: transparent; cursor: pointer; margin-bottom: var(--space-md); text-align: left; padding: var(--space-md) 0;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="width: 20px; height: 20px;">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                    </svg>
                    <span>Night Mode</span>
                </button>
                <div class="flex items-center justify-between">
                    <span class="text-muted" style="font-size: 0.875rem;">API Status</span>
                    <span id="apiStatus"><span class="badge badge-warning">‚óè Checking...</span></span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">Patient <span class="text-gradient">Records</span></h1>
                <p class="page-subtitle">View and search clinical notes generated by AI</p>
            </div>

            <!-- Search and Filter -->
            <div class="card mb-lg">
                <div class="flex gap-md items-center" style="flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px; margin: 0;">
                        <input type="text" class="form-input" id="searchInput"
                            placeholder="Search by name, diagnosis, or ICD code...">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <select class="form-select" id="diagnosisFilter">
                            <option value="">All Diagnoses</option>
                            <option value="Malignant">Malignant Tumor</option>
                            <option value="Benign">Benign Tumor</option>
                            <option value="No Tumor">No Tumor</option>
                        </select>
                    </div>
                    <span id="recordCount" class="text-muted" style="font-size: 0.875rem;"></span>
                </div>
            </div>

            <!-- Records Table -->
            <div class="card">
                <div class="table-container">
                    <table class="data-table" id="recordsTable">
                        <thead>
                            <tr>
                                <th>Patient ID</th>
                                <th>Name</th>
                                <th>Age</th>
                                <th>Gender</th>
                                <th>Diagnosis</th>
                                <th>ICD-10</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="recordsBody">
                            <tr>
                                <td colspan="7" class="text-center text-muted" style="padding: var(--space-2xl);">
                                    Loading records...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Detail Modal -->
            <div id="detailModal" class="loading-overlay" style="display: none;">
                <div class="card"
                    style="max-width: 700px; max-height: 90vh; overflow-y: auto; margin: var(--space-lg);">
                    <div class="card-header">
                        <h2 class="card-title" id="modalTitle">Patient Details</h2>
                        <button class="btn btn-secondary btn-icon" onclick="closeModal()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18" />
                                <line x1="6" y1="6" x2="18" y2="18" />
                            </svg>
                        </button>
                    </div>

                    <div id="modalContent">
                        <div class="stats-grid"
                            style="grid-template-columns: repeat(4, 1fr); margin-bottom: var(--space-lg);">
                            <div>
                                <p class="text-muted" style="font-size: 0.75rem; margin-bottom: var(--space-xs);">
                                    PATIENT ID</p>
                                <p id="detailId" style="font-weight: 600;"></p>
                            </div>
                            <div>
                                <p class="text-muted" style="font-size: 0.75rem; margin-bottom: var(--space-xs);">AGE
                                </p>
                                <p id="detailAge" style="font-weight: 600;"></p>
                            </div>
                            <div>
                                <p class="text-muted" style="font-size: 0.75rem; margin-bottom: var(--space-xs);">GENDER
                                </p>
                                <p id="detailGender" style="font-weight: 600;"></p>
                            </div>
                            <div>
                                <p class="text-muted" style="font-size: 0.75rem; margin-bottom: var(--space-xs);">ICD-10
                                </p>
                                <span class="icd-code" id="detailIcd"></span>
                            </div>
                        </div>

                        <div style="margin-bottom: var(--space-lg);">
                            <p class="text-muted" style="font-size: 0.75rem; margin-bottom: var(--space-xs);">SYMPTOMS
                            </p>
                            <p id="detailSymptoms"></p>
                        </div>

                        <div style="margin-bottom: var(--space-lg);">
                            <p class="text-muted" style="font-size: 0.75rem; margin-bottom: var(--space-xs);">MRI
                                FINDINGS</p>
                            <p id="detailMri"></p>
                        </div>

                        <div style="margin-bottom: var(--space-lg);">
                            <p class="text-muted" style="font-size: 0.75rem; margin-bottom: var(--space-xs);">
                                PROVISIONAL DIAGNOSIS</p>
                            <p id="detailDiagnosis" style="font-weight: 600;"></p>
                        </div>

                        <div>
                            <p class="text-muted" style="font-size: 0.75rem; margin-bottom: var(--space-xs);">CLINICAL
                                NOTE</p>
                            <div class="clinical-note" id="detailNote"></div>
                        </div>
                    </div>

                    <div class="flex gap-md mt-lg">
                        <button class="btn btn-primary" onclick="copyRecord()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                            </svg>
                            Copy to Clipboard
                        </button>
                        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    <script>
        let allRecords = [];
        let currentRecord = null;

        // Load records on page load
        document.addEventListener('DOMContentLoaded', loadRecords);

        async function loadRecords() {
            try {
                // Load from local JSON file
                const response = await fetch('../data/FINAL_CLINICAL_NOTES.json');
                allRecords = await response.json();
                renderRecords(allRecords);
            } catch (error) {
                console.error('Failed to load records:', error);
                document.getElementById('recordsBody').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center" style="padding: var(--space-2xl); color: var(--error);">
                            Failed to load records. Make sure the data file exists.
                        </td>
                    </tr>
                `;
            }
        }

        function renderRecords(records) {
            const tbody = document.getElementById('recordsBody');
            const countEl = document.getElementById('recordCount');

            countEl.textContent = `${records.length} record${records.length !== 1 ? 's' : ''} found`;

            if (records.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted" style="padding: var(--space-2xl);">
                            No records match your search.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = records.map((record, index) => `
                <tr class="animate-fade-in" style="animation-delay: ${index * 0.05}s;">
                    <td><code style="color: var(--primary);">${record.patient_id}</code></td>
                    <td>${record.patient_name}</td>
                    <td>${record.age}</td>
                    <td>${record.gender}</td>
                    <td>
                        <span class="badge ${getDiagnosisBadge(record.provisional_diagnosis)}">
                            ${record.provisional_diagnosis}
                        </span>
                    </td>
                    <td><span class="icd-code">${record.icd10_code}</span></td>
                    <td>
                        <button class="btn btn-secondary btn-icon" onclick="showDetail(${index})" title="View details">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getDiagnosisBadge(diagnosis) {
            if (diagnosis.toLowerCase().includes('malignant')) return 'badge-error';
            if (diagnosis.toLowerCase().includes('benign')) return 'badge-warning';
            return 'badge-success';
        }

        // Search and filter
        document.getElementById('searchInput').addEventListener('input', filterRecords);
        document.getElementById('diagnosisFilter').addEventListener('change', filterRecords);

        function filterRecords() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const diagnosisFilter = document.getElementById('diagnosisFilter').value.toLowerCase();

            const filtered = allRecords.filter(record => {
                const matchesSearch = !search ||
                    record.patient_name.toLowerCase().includes(search) ||
                    record.provisional_diagnosis.toLowerCase().includes(search) ||
                    record.icd10_code.toLowerCase().includes(search) ||
                    record.clinical_note.toLowerCase().includes(search);

                const matchesDiagnosis = !diagnosisFilter ||
                    record.provisional_diagnosis.toLowerCase().includes(diagnosisFilter);

                return matchesSearch && matchesDiagnosis;
            });

            renderRecords(filtered);
        }

        // Show detail modal
        function showDetail(index) {
            currentRecord = allRecords[index];

            document.getElementById('modalTitle').textContent = currentRecord.patient_name;
            document.getElementById('detailId').textContent = currentRecord.patient_id;
            document.getElementById('detailAge').textContent = currentRecord.age + ' years';
            document.getElementById('detailGender').textContent = currentRecord.gender;
            document.getElementById('detailIcd').textContent = currentRecord.icd10_code;
            document.getElementById('detailSymptoms').textContent = currentRecord.symptoms;
            document.getElementById('detailMri').textContent = currentRecord.mri_findings;
            document.getElementById('detailDiagnosis').textContent = currentRecord.provisional_diagnosis;
            document.getElementById('detailNote').textContent = currentRecord.clinical_note;

            document.getElementById('detailModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
            currentRecord = null;
        }

        function copyRecord() {
            if (!currentRecord) return;

            const text = `Patient: ${currentRecord.patient_name}
ID: ${currentRecord.patient_id}
Age: ${currentRecord.age}, Gender: ${currentRecord.gender}

Symptoms: ${currentRecord.symptoms}
MRI Findings: ${currentRecord.mri_findings}
Diagnosis: ${currentRecord.provisional_diagnosis}

Clinical Note:
${currentRecord.clinical_note}

ICD-10: ${currentRecord.icd10_code} - ${currentRecord.icd10_description}`;

            EHRApp.copyToClipboard(text);
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // Close modal on backdrop click
        document.getElementById('detailModal').addEventListener('click', (e) => {
            if (e.target.id === 'detailModal') closeModal();
        });
    </script>
</body>

</html>